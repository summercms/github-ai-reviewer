import { context } from "@actions/github";
import { FileDiff } from "./diff";
import { PullRequestSummary } from "./prompts";

export function buildInitialMessage(
  commits: {
    sha: string;
    commit: {
      message: string;
    };
  }[],
  fileDiffs: FileDiff[]
): string {
  const { owner, repo } = context.repo;

  let message = `â³ **Analyzing changes in this PR...** â³\n\n`;
  message += `_This might take a few minutes, please wait_\n\n`;

  // Group files by operation

  message += `<details>\n<summary>ğŸ“¥ Commits</summary>\n\n`;
  message += `Analyzing changes from base commit (\`${commits[0].sha.slice(
    0,
    7
  )}\`) to head commit (\`${commits[commits.length - 1].sha.slice(0, 7)}\`):\n`;

  for (const commit of commits.reverse()) {
    message += `- [${commit.sha.slice(
      0,
      7
    )}](https://github.com/${owner}/${repo}/commit/${commit.sha}): ${
      commit.commit.message
    }\n`;
  }

  message += "\n\n</details>\n\n";

  message += `<details>\n<summary>ğŸ“ Files being considered (${fileDiffs.length})</summary>\n\n`;
  for (const diff of fileDiffs) {
    let prefix = "ğŸ”„"; // Modified
    if (diff.status === "added") prefix = "â•";
    if (diff.status === "removed") prefix = "â–";
    if (diff.status === "renamed") prefix = "ğŸ“";

    let fileText = `${prefix} ${diff.filename}`;
    if (diff.status === "renamed") {
      fileText += ` (from ${diff.previous_filename})`;
    }
    fileText += ` _(${diff.hunks.length} hunks)_`;
    message += `${fileText}\n`;
  }
  message += "\n</details>\n\n";

  message += "--- \n_autogenerated by presubmit.ai_";

  return message;
}

export function buildWalkthroughMessage(summary: PullRequestSummary): string {
  let message = `# ğŸ“– Walkthrough\n\n`;

  // Add description with proper spacing
  message += `${summary.description.trim()}\n\n`;

  message += `## Changes\n\n`;

  // Create table with proper column alignment and escaping
  message += `| File | Summary |\n`;
  message += `|:----------|:---------------|\n`; // Left-align columns

  for (const file of summary.files) {
    // Escape pipes and wrap paths in backticks for better formatting
    const escapedPath = file.filename.replace(/\|/g, "\\|");
    const escapedSummary = file.summary.replace(/\|/g, "\\|");

    message += `| \`${escapedPath}\` | ${escapedSummary} |\n`;
  }

  return message;
}
